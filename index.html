<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<style>
			html, body 	{margin: 0; padding: 0; overflow: hidden;}
			#selector {
				position: absolute;
				top: 5px;
				right: 5px;
			}
			#videocontainer {
				position: absolute;
				top: 5px;
				left: 5px;
				max-width: 20vw;
			}
			#videocontainer video {
				width: 100%;
			}
			#videoCanvas {
				position: absolute;
				left: 0;
				pointer-events: none;
			}
			#videoSelector {
				position: absolute;
				top: 0;
				right: 0;
			}
		</style>
	</head>
	<body>
		<div id="container"></div>
		<div id="videocontainer">
			<input id="videoPicker" type="file" accept="video/*"/>
			<select id="videoSelector">
				<option value="">None</option>
				<option value="fire.webm">Fire</option>
				<option value="mood_lights.webm">Mood lights</option>
				<option value="trippy_visuals.webm">Trippy visuals</option>
			</select>
			<video id="video" controls autoplay loop></video>
			<canvas id="videoCanvas"></canvas>
		</div>
		<select id="selector">
			<option value="0">hue by angle</option>
			<option value="1">hue by height</option>
			<option value="2">video unfolded</option>
			<option value="3">video squished</option>
		</select>
		<script src="three.min.js"></script>
		<script src="BufferGeometryUtils.js"></script>
		<script src="OrbitControls.js"></script>
		<script>
			(function localFileVideoPlayer() {
				'use strict'
				let URL = window.URL || window.webkitURL
				let playSelectedFile = function (event) {
					let file = this.files[0]
					let type = file.type
					let fileURL = URL.createObjectURL(file)
					video.src = fileURL;
				}
				video.addEventListener('loadedmetadata', function() {
					videoCanvas.width = Math.floor(video.clientWidth);
					videoCanvas.height = Math.floor(video.clientHeight);
				}, false)
				videoPicker.addEventListener('change', playSelectedFile, false);
				videoSelector.addEventListener('change', function(){
					video.src = `${window.location}/videos/${videoSelector.value}`;
				}, false);
			})();
		</script>
		<script>
			var camera, controls, scene, renderer, nLights, color, colorInstancedBufferAttribute;
			let minX = minY = minZ = minAngleZ = maxX = maxY = maxZ = maxAngleZ = 0;
			let lastFrame = 0;
			let cylinders = [];
			let lights = [];
			let SCALE = 1/1000;
			let LEDDistance = 60 * SCALE;
			let tubeMaterial = new THREE.MeshPhongMaterial({
				transparent: true,
				opacity: 0.8,
				blending: THREE.AdditiveBlending,
				color: 0xffffff,
				side: THREE.BackSide,
			});
			const vizualisations = [
				function hueByAngle(offset, timestamp) {
					const _color = new THREE.Color();
					for (let i = 0; i < nLights; i++) {
						let {x, y, angleX} = lights[i].meta;
						_color.setHSL((angleX/(2*Math.PI) + timestamp/5000) % 1, 1, 0.5);
						_color.toArray(color, i * 3);
					}
				},
				function hueByHeight(offset, timestamp) {
					const _color = new THREE.Color();
					for (let i = 0; i < nLights; i++) {
						let {x, y, z} = lights[i].position;
						let height = (minZ + z)/(maxZ-minZ);
						_color.setHSL((height + timestamp/5000) % 1, 1, 0.5);
						_color.toArray(color, i * 3);
					}
				},
				function videoUnfolded(offset, timestamp) {
					const _color = new THREE.Color();
					let ctx = videoCanvas.getContext("2d");
					ctx.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);
					let frame = ctx.getImageData(0, 0, videoCanvas.width, videoCanvas.height);
					ctx.fillStyle = "white";
					let data = Array.from(frame.data).map(v => v/256);
					for (let i = 0; i < nLights; i++) {
						let {angleX, angleZ} = lights[i].meta;
						let H = Math.floor((minAngleZ + angleZ)/(maxAngleZ - minAngleZ)*videoCanvas.height);
						let W = Math.floor(videoCanvas.width - (Math.PI+angleX)/(2*Math.PI)*videoCanvas.width);
						ctx.fillRect(W, H, 1, 1);
						let idx = H*videoCanvas.width*4+W*4;
						_color.fromArray(data, idx);
						_color.toArray(color, i * 3);
					}
				},
				function videoSquished(offset, timestamp) {
					const _color = new THREE.Color();
					let ctx = videoCanvas.getContext("2d");
					ctx.drawImage(video, 0, 0, videoCanvas.width, videoCanvas.height);
					let frame = ctx.getImageData(0, 0, videoCanvas.width, videoCanvas.height);
					ctx.fillStyle = "white";
					let data = Array.from(frame.data).map(v => v/256);
					for (let i = 0; i < nLights; i++) {
						let {x, y, z, angleX, angleZ} = lights[i].meta;
						let H = Math.floor(videoCanvas.height/2+Math.sin(Math.PI-angleX) * (angleZ - minAngleZ)/(maxAngleZ - minAngleZ) * videoCanvas.height/2);
						let W = Math.floor(videoCanvas.width/2 + Math.cos(Math.PI+angleX) * (angleZ - minAngleZ)/(maxAngleZ - minAngleZ) * videoCanvas.height/2);
						ctx.fillRect(W, H, 1, 1);
						let idx = H*videoCanvas.width*4+W*4;
						_color.fromArray(data, idx);
						_color.toArray(color, i * 3);
					}
				}
			];
			const geometry = new THREE.BoxBufferGeometry( 20 * SCALE, 20 * SCALE, 60 * SCALE );
			geometry.computeVertexNormals();
			const material = new THREE.MeshBasicMaterial({color: 0xffffff});

			init();
			requestAnimationFrame( animate );


			function init() {
				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 20000 * SCALE );
				camera.position.set( 6000 * SCALE, 6000 * SCALE, 0 * SCALE );


				renderer = new THREE.WebGLRenderer( { antialias: true } );
				controls = new THREE.OrbitControls( camera, renderer.domElement );

				controls.rotateSpeed = 1.0;
				controls.zoomSpeed = 1.2;
				controls.panSpeed = 0.8;

				controls.noZoom = false;
				controls.noPan = false;

				controls.staticMoving = true;
				controls.dynamicDampingFactor = 0.3;

				controls.addEventListener( 'change', render );

				// world

				scene = new THREE.Scene();


				// renderer

				// renderer.setClearColor( 0x404040 );
				const light = new THREE.AmbientLight( 0x404040 ); // soft white light
				scene.add( light );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.outputEncoding = THREE.sRGBEncoding;
				renderer.setSize( window.innerWidth, window.innerHeight );

				container = document.getElementById( 'container' );
				container.appendChild( renderer.domElement );

				window.addEventListener( 'resize', onWindowResize, false );

				function createCylinder(vstart, vend, scene){
					var HALF_PI = Math.PI * .5;
					var distance = vstart.distanceTo(vend);
					var position  = vend.clone().add(vstart).divideScalar(2);

					var cylinder = new THREE.CylinderBufferGeometry(10*SCALE,10*SCALE,distance,16,16,false);

					var orientation = new THREE.Matrix4();//a new orientation matrix to offset pivot
					var offsetRotation = new THREE.Matrix4();//a matrix to fix pivot rotation
					var offsetPosition = new THREE.Matrix4();//a matrix to fix pivot position
					orientation.lookAt(vstart,vend,new THREE.Vector3(0,1,0));//look at destination
					offsetRotation.makeRotationX(HALF_PI);//rotate 90 degs on X
					orientation.multiply(offsetRotation);//combine orientation with rotation transformations
					let quaternion = new THREE.Quaternion();
					let scale = new THREE.Vector3();
					orientation.decompose(new THREE.Vector3(), quaternion, scale);
					orientation.compose(position, quaternion, scale);
					cylinder.applyMatrix4(orientation);

					let LEDCount = Math.floor((distance - LEDDistance) / LEDDistance);
					let offsetDistance = (distance - (LEDCount * LEDDistance)) / 2;
					let directionVector = vend.clone().sub(vstart).normalize();
					let offsetVector = directionVector.clone().multiplyScalar(offsetDistance);
					let LEDVector = directionVector.clone().multiplyScalar(LEDDistance);

					// construct "lights" for this particular cylinder. Later we convert these to instances.
					for (let idx = 0; idx <= LEDCount; idx++) {
						let lightMesh = new THREE.Mesh(geometry, material);
						lightMesh.position.copy(vstart.clone().add(offsetVector).add(LEDVector.clone().multiplyScalar(idx)));
						lightMesh.lookAt(vend);
						lights.push(lightMesh);
						let {x:y, y:z, z:x} = lightMesh.position;
						let angleX = Math.atan2(y, x);
						let angleZ = Math.atan2(Math.sqrt(x**2 + y**2), z);
						if (x < minX) minX = x;
						if (y < minY) minY = y;
						if (z < minZ) minZ = z;
						if (angleZ < minAngleZ) minAngleZ = angleZ;
						if (x > maxX) maxX = x;
						if (y > maxY) maxY = y;
						if (z > maxZ) maxZ = z;
						if (angleZ > maxAngleZ) maxAngleZ = angleZ;
						lightMesh.meta = {
							x, y, z,
							angleX, angleZ
						}
					}

					return cylinder;
				}


				let facets, vertexes, vertexGroups = [], edges=[];
				let uniqueEdges = [
					[[1779.151961914786,2448.7925941502604,0],[1243.5667427870335,2769.4638366627887,1107.002042513259]],
					[[621.7833713935172,2971.493500818643,49.16098752175943],[1779.151961914786,2448.7925941502604,0]],
					[[621.7833713935172,2971.493500818643,49.16098752175943],[1243.5667427870335,2769.4638366627887,1107.002042513259]],
					[[1243.5667427870335,1711.6227816712894,2818.624824184552],[0,1870.7110791327584,3026.874109167793]],
					[[621.7833713935154,855.8113908356414,3472.4065508643475],[0,1870.7110791327584,3026.874109167793]],
					[[621.7833713935154,855.8113908356414,3472.4065508643475],[1243.5667427870335,1711.6227816712894,2818.624824184552]],
					[[2633.9166285019264,202.0296641558509,2164.843097504758],[2012.133257108411,-653.7817266797988,2818.624824184552]],
					[[2621.349872596708,-851.7282043242893,1956.2066987911328],[2012.133257108411,-653.7817266797988,2818.624824184552]],
					[[2633.9166285019264,202.0296641558509,2164.843097504758],[2621.349872596708,-851.7282043242893,1956.2066987911328]],
					[[2878.72834552912,-935.355539566418,0],[2633.9166285019264,-1509.5931175154503,1107.00204251326]],
					[[2633.9166285019264,-1509.5931175154503,1107.00204251326],[2249.6333713412378,-2038.513645011201,49.160987521760575]],
					[[2878.72834552912,-935.355539566418,0],[2249.6333713412378,-2038.513645011201,49.160987521760575]],
					[[1779.151961914753,578.0815150175193,3026.874109167793],[1243.5667427870335,1711.6227816712894,2818.624824184552]],
					[[621.7833713935154,855.8113908356414,3472.4065508643475],[1779.151961914753,578.0815150175193,3026.874109167793]],
					[[621.7833713935154,855.8113908356414,3472.4065508643475],[1006.0666285542147,-326.89086333990076,3472.4065508643444]],
					[[1779.151961914753,578.0815150175193,3026.874109167793],[1006.0666285542147,-326.89086333990076,3472.4065508643444]],
					[[2249.633371341245,1384.7319183313923,2164.8430975047595],[1243.5667427870335,1711.6227816712894,2818.624824184552]],
					[[2249.633371341245,1384.7319183313923,2164.8430975047595],[1779.151961914753,578.0815150175193,3026.874109167793]],
					[[-2633.9166285019287,202.02966415586275,2164.8430975047595],[-2249.633371341231,1384.7319183313994,2164.843097504758]],
					[[-2633.9166285019287,202.02966415586275,2164.8430975047595],[-1779.151961914748,578.0815150175213,3026.874109167793]],
					[[-2249.633371341231,1384.7319183313994,2164.843097504758],[-1779.151961914748,578.0815150175213,3026.874109167793]],
					[[3018.199885662619,326.89086333989434,49.16098752175943],[3018.199885662619,-326.89086333990167,1107.002042513259]],
					[[3018.199885662619,-326.89086333990167,1107.002042513259],[2878.72834552912,-935.355539566418,0]],
					[[3018.199885662619,326.89086333989434,49.16098752175943],[2878.72834552912,-935.355539566418,0]],
					[[2012.133257108411,-653.7817266797988,2818.624824184552],[1779.151961914753,578.0815150175193,3026.874109167793]],
					[[2012.133257108411,-653.7817266797988,2818.624824184552],[1006.0666285542147,-326.89086333990076,3472.4065508643444]],
					[[1779.1519619147455,-2448.7925941502913,1156.1630300350205],[1243.5667427870262,-2769.463836662794,49.16098752175943]],
					[[2249.6333713412378,-2038.513645011201,49.160987521760575],[1243.5667427870262,-2769.463836662794,49.16098752175943]],
					[[2249.6333713412378,-2038.513645011201,49.160987521760575],[1779.1519619147455,-2448.7925941502913,1156.1630300350205]],
					[[3018.199885662619,-326.89086333990167,1107.002042513259],[2878.728345529135,935.3555395663697,1156.1630300350205]],
					[[3018.199885662619,326.89086333989434,49.16098752175943],[2878.728345529135,935.3555395663697,1156.1630300350205]],
					[[-3018.1998856626215,-326.89086333988706,1107.00204251326],[-2633.9166285019287,-1509.5931175154356,1107.002042513259]],
					[[-2633.9166285019287,-1509.5931175154356,1107.002042513259],[-2621.349872596707,-851.7282043242893,1956.2066987911328]],
					[[-3018.1998856626215,-326.89086333988706,1107.00204251326],[-2621.349872596707,-851.7282043242893,1956.2066987911328]],
					[[-621.7833713935245,-2971.493500818648,1107.00204251326],[-1006.0666285542153,-2442.5729733228973,2164.8430975047595]],
					[[0,-2756.2503675472317,1956.2066987911328],[-621.7833713935245,-2971.493500818648,1107.00204251326]],
					[[0,-2756.2503675472317,1956.2066987911328],[-1006.0666285542153,-2442.5729733228973,2164.8430975047595]],
					[[621.7833713935154,855.8113908356414,3472.4065508643475],[-621.7833713935154,855.8113908356414,3472.4065508643466]],
					[[0,0,3659.663107439707],[-621.7833713935154,855.8113908356414,3472.4065508643466]],
					[[621.7833713935154,855.8113908356414,3472.4065508643475],[0,0,3659.663107439707]],
					[[2633.9166285019264,202.0296641558509,2164.843097504758],[1779.151961914753,578.0815150175193,3026.874109167793]],
					[[2249.633371341245,2038.5136450111863,1107.00204251326],[2249.633371341245,1384.7319183313923,2164.8430975047595]],
					[[2878.728345529135,935.3555395663697,1156.1630300350205],[2249.633371341245,1384.7319183313923,2164.8430975047595]],
					[[2878.728345529135,935.3555395663697,1156.1630300350205],[2249.633371341245,2038.5136450111863,1107.00204251326]],
					[[-1779.1519619147641,-2448.7925941502767,1156.1630300350205],[-1243.5667427870394,-2769.463836662794,49.160987521760575]],
					[[-621.7833713935245,-2971.493500818648,1107.00204251326],[-1243.5667427870394,-2769.463836662794,49.160987521760575]],
					[[-621.7833713935245,-2971.493500818648,1107.00204251326],[-1779.1519619147641,-2448.7925941502767,1156.1630300350205]],
					[[2633.9166285019264,202.0296641558509,2164.843097504758],[2249.633371341245,1384.7319183313923,2164.8430975047595]],
					[[1243.5667427870335,2769.4638366627887,1107.002042513259],[1.277263992169454e-11,3026.874109167803,1156.1630300350205]],
					[[621.7833713935172,2971.493500818643,49.16098752175943],[1.277263992169454e-11,3026.874109167803,1156.1630300350205]],
					[[621.7833713935099,-2971.493500818646,1107.002042513259],[1006.0666285542037,-2442.5729733228973,2164.843097504758]],
					[[621.7833713935099,-2971.493500818646,1107.002042513259],[1779.1519619147455,-2448.7925941502913,1156.1630300350205]],
					[[1779.1519619147455,-2448.7925941502913,1156.1630300350205],[1006.0666285542037,-2442.5729733228973,2164.843097504758]],
					[[1006.0666285542147,-326.89086333990076,3472.4065508643444],[0,0,3659.663107439707]],
					[[-2633.9166285019214,1509.5931175154428,49.16098752175943],[-1779.1519619147205,2448.792594150308,0]],
					[[-2633.9166285019214,1509.5931175154428,49.16098752175943],[-2249.633371341229,2038.5136450111956,1107.002042513259]],
					[[-2249.633371341229,2038.5136450111956,1107.002042513259],[-1779.1519619147205,2448.792594150308,0]],
					[[-1779.151961914748,578.0815150175213,3026.874109167793],[-1006.0666285542079,-326.8908633398989,3472.4065508643457]],
					[[-2012.1332571084135,-653.7817266797869,2818.624824184552],[-1779.151961914748,578.0815150175213,3026.874109167793]],
					[[-2012.1332571084135,-653.7817266797869,2818.624824184552],[-1006.0666285542079,-326.8908633398989,3472.4065508643457]],
					[[-2633.9166285019287,202.02966415586275,2164.8430975047595],[-2012.1332571084135,-653.7817266797869,2818.624824184552]],
					[[-621.7833713935154,855.8113908356414,3472.4065508643466],[-1779.151961914748,578.0815150175213,3026.874109167793]],
					[[-621.7833713935154,855.8113908356414,3472.4065508643466],[-1006.0666285542079,-326.8908633398989,3472.4065508643457]],
					[[-621.7833713935154,2567.4341725069353,2164.843097504758],[-1243.5667427870321,1711.6227816712894,2818.624824184553]],
					[[-621.7833713935154,2567.4341725069353,2164.843097504758],[-1620.0833176699705,2229.8533880979076,1956.2066987911328]],
					[[-1620.0833176699705,2229.8533880979076,1956.2066987911328],[-1243.5667427870321,1711.6227816712894,2818.624824184553]],
					[[-3018.1998856626215,326.8908633399071,49.160987521760575],[-2878.728345529122,935.3555395663951,1156.1630300350205]],
					[[-3018.1998856626215,326.8908633399071,49.160987521760575],[-3018.1998856626215,-326.89086333988706,1107.00204251326]],
					[[-3018.1998856626215,-326.89086333988706,1107.00204251326],[-2878.728345529122,935.3555395663951,1156.1630300350205]],
					[[-1620.0833176699705,2229.8533880979076,1956.2066987911328],[-1243.5667427870285,2769.4638366627923,1107.002042513259]],
					[[-2249.633371341229,2038.5136450111956,1107.002042513259],[-1243.5667427870285,2769.4638366627923,1107.002042513259]],
					[[-2249.633371341229,2038.5136450111956,1107.002042513259],[-1620.0833176699705,2229.8533880979076,1956.2066987911328]],
					[[-621.7833713935154,2971.493500818643,49.16098752175943],[-1243.5667427870285,2769.4638366627923,1107.002042513259]],
					[[-621.7833713935154,2971.493500818643,49.16098752175943],[-1779.1519619147205,2448.792594150308,0]],
					[[-1779.1519619147205,2448.792594150308,0],[-1243.5667427870285,2769.4638366627923,1107.002042513259]],
					[[-2249.633371341231,1384.7319183313994,2164.843097504758],[-1620.0833176699705,2229.8533880979076,1956.2066987911328]],
					[[-2249.633371341231,1384.7319183313994,2164.843097504758],[-1243.5667427870321,1711.6227816712894,2818.624824184553]],
					[[-621.7833713935154,855.8113908356414,3472.4065508643466],[-1243.5667427870321,1711.6227816712894,2818.624824184553]],
					[[-1779.151961914748,578.0815150175213,3026.874109167793],[-1243.5667427870321,1711.6227816712894,2818.624824184553]],
					[[0,0,3659.663107439707],[-1006.0666285542079,-326.8908633398989,3472.4065508643457]],
					[[-3018.1998856626215,-326.89086333988706,1107.00204251326],[-2878.728345529142,-935.3555395663441,0]],
					[[-2878.728345529142,-935.3555395663441,0],[-2633.9166285019287,-1509.5931175154356,1107.002042513259]],
					[[3018.199885662619,-326.89086333990167,1107.002042513259],[2621.349872596708,-851.7282043242893,1956.2066987911328]],
					[[3018.199885662619,-326.89086333990167,1107.002042513259],[2633.9166285019264,202.0296641558509,2164.843097504758]],
					[[2012.133257108415,-1711.6227816713038,2164.8430975047595],[2012.133257108411,-653.7817266797988,2818.624824184552]],
					[[2621.349872596708,-851.7282043242893,1956.2066987911328],[2012.133257108415,-1711.6227816713038,2164.8430975047595]],
					[[-2878.728345529122,935.3555395663951,1156.1630300350205],[-2249.633371341231,1384.7319183313994,2164.843097504758]],
					[[-2878.728345529122,935.3555395663951,1156.1630300350205],[-2633.9166285019287,202.02966415586275,2164.8430975047595]],
					[[-2012.1332571084135,-1711.6227816712894,2164.843097504758],[-1006.0666285542153,-2442.5729733228973,2164.8430975047595]],
					[[-2012.1332571084135,-1711.6227816712894,2164.843097504758],[-1779.1519619147641,-2448.7925941502767,1156.1630300350205]],
					[[-1779.1519619147641,-2448.7925941502767,1156.1630300350205],[-1006.0666285542153,-2442.5729733228973,2164.8430975047595]],
					[[0,1870.7110791327584,3026.874109167793],[-621.7833713935154,855.8113908356414,3472.4065508643466]],
					[[0,1870.7110791327584,3026.874109167793],[-1243.5667427870321,1711.6227816712894,2818.624824184553]],
					[[2012.133257108415,-1711.6227816713038,2164.8430975047595],[1006.0666285542037,-2442.5729733228973,2164.843097504758]],
					[[2012.133257108415,-1711.6227816713038,2164.8430975047595],[1779.1519619147455,-2448.7925941502913,1156.1630300350205]],
					[[2249.633371341245,1384.7319183313923,2164.8430975047595],[1620.0833176699705,2229.8533880979057,1956.2066987911328]],
					[[1620.0833176699705,2229.8533880979057,1956.2066987911328],[1243.5667427870335,1711.6227816712894,2818.624824184552]],
					[[-1006.0666285542079,-326.8908633398989,3472.4065508643457],[-1.824662845956363e-12,-1057.8410549915034,3472.4065508643457]],
					[[0,0,3659.663107439707],[-1.824662845956363e-12,-1057.8410549915034,3472.4065508643457]],
					[[-621.7833713935245,-2971.493500818648,1107.00204251326],[-4.0142582611039987e-11,-3026.874109167806,0]],
					[[621.7833713935099,-2971.493500818646,1107.002042513259],[-4.0142582611039987e-11,-3026.874109167806,0]],
					[[621.7833713935099,-2971.493500818646,1107.002042513259],[-621.7833713935245,-2971.493500818648,1107.00204251326]],
					[[-2249.633371341231,1384.7319183313994,2164.843097504758],[-2249.633371341229,2038.5136450111956,1107.002042513259]],
					[[621.7833713935172,2971.493500818643,49.16098752175943],[-621.7833713935154,2971.493500818643,49.16098752175943]],
					[[1.277263992169454e-11,3026.874109167803,1156.1630300350205],[-621.7833713935154,2971.493500818643,49.16098752175943]],
					[[-621.7833713935154,2567.4341725069353,2164.843097504758],[-1243.5667427870285,2769.4638366627923,1107.002042513259]],
					[[621.7833713935172,2567.4341725069353,2164.843097504758],[1620.0833176699705,2229.8533880979057,1956.2066987911328]],
					[[1620.0833176699705,2229.8533880979057,1956.2066987911328],[1243.5667427870335,2769.4638366627887,1107.002042513259]],
					[[621.7833713935172,2567.4341725069353,2164.843097504758],[1243.5667427870335,2769.4638366627887,1107.002042513259]],
					[[1006.0666285542037,-2442.5729733228973,2164.843097504758],[0,-2756.2503675472317,1956.2066987911328]],
					[[621.7833713935099,-2971.493500818646,1107.002042513259],[0,-2756.2503675472317,1956.2066987911328]],
					[[621.7833713935172,2567.4341725069353,2164.843097504758],[1.277263992169454e-11,3026.874109167803,1156.1630300350205]],
					[[1.277263992169454e-11,3026.874109167803,1156.1630300350205],[-621.7833713935154,2567.4341725069353,2164.843097504758]],
					[[621.7833713935172,2567.4341725069353,2164.843097504758],[-621.7833713935154,2567.4341725069353,2164.843097504758]],
					[[2249.633371341245,2038.5136450111863,1107.00204251326],[1779.151961914786,2448.7925941502604,0]],
					[[2249.633371341245,2038.5136450111863,1107.00204251326],[1243.5667427870335,2769.4638366627887,1107.002042513259]],
					[[1006.0666285542147,-326.89086333990076,3472.4065508643444],[-1.824662845956363e-12,-1057.8410549915034,3472.4065508643457]],
					[[-3018.1998856626215,-326.89086333988706,1107.00204251326],[-2633.9166285019287,202.02966415586275,2164.8430975047595]],
					[[2633.9166285019264,-1509.5931175154503,1107.00204251326],[2012.133257108415,-1711.6227816713038,2164.8430975047595]],
					[[2633.9166285019264,-1509.5931175154503,1107.00204251326],[2621.349872596708,-851.7282043242893,1956.2066987911328]],
					[[3018.199885662619,-326.89086333990167,1107.002042513259],[2633.9166285019264,-1509.5931175154503,1107.00204251326]],
					[[2878.728345529135,935.3555395663697,1156.1630300350205],[2633.9166285019264,202.0296641558509,2164.843097504758]],
					[[2878.728345529135,935.3555395663697,1156.1630300350205],[2633.9166285019373,1509.5931175154356,49.160987521760575]],
					[[3018.199885662619,326.89086333989434,49.16098752175943],[2633.9166285019373,1509.5931175154356,49.160987521760575]],
					[[-2012.1332571084135,-653.7817266797869,2818.624824184552],[-1099.576383614374,-1513.4370545838972,3026.874109167793]],
					[[-2012.1332571084135,-653.7817266797869,2818.624824184552],[-2012.1332571084135,-1711.6227816712894,2164.843097504758]],
					[[-2012.1332571084135,-1711.6227816712894,2164.843097504758],[-1099.576383614374,-1513.4370545838972,3026.874109167793]],
					[[-1099.576383614374,-1513.4370545838972,3026.874109167793],[-1006.0666285542153,-2442.5729733228973,2164.8430975047595]],
					[[-2633.9166285019287,-1509.5931175154356,1107.002042513259],[-2249.6333713412364,-2038.5136450111863,49.16098752175943]],
					[[-2249.6333713412364,-2038.5136450111863,49.16098752175943],[-1779.1519619147641,-2448.7925941502767,1156.1630300350205]],
					[[-2633.9166285019287,-1509.5931175154356,1107.002042513259],[-1779.1519619147641,-2448.7925941502767,1156.1630300350205]],
					[[-1099.576383614374,-1513.4370545838972,3026.874109167793],[-1006.0666285542079,-326.8908633398989,3472.4065508643457]],
					[[-2878.728345529122,935.3555395663951,1156.1630300350205],[-2633.9166285019214,1509.5931175154428,49.16098752175943]],
					[[-2878.728345529122,935.3555395663951,1156.1630300350205],[-2249.633371341229,2038.5136450111956,1107.002042513259]],
					[[2633.9166285019373,1509.5931175154356,49.160987521760575],[2249.633371341245,2038.5136450111863,1107.00204251326]],
					[[-2633.9166285019287,-1509.5931175154356,1107.002042513259],[-2012.1332571084135,-1711.6227816712894,2164.843097504758]],
					[[-2621.349872596707,-851.7282043242893,1956.2066987911328],[-2012.1332571084135,-1711.6227816712894,2164.843097504758]],
					[[-2633.9166285019287,202.02966415586275,2164.8430975047595],[-2621.349872596707,-851.7282043242893,1956.2066987911328]],
					[[-2621.349872596707,-851.7282043242893,1956.2066987911328],[-2012.1332571084135,-653.7817266797869,2818.624824184552]],
					[[0,1870.7110791327584,3026.874109167793],[-621.7833713935154,2567.4341725069353,2164.843097504758]],
					[[1.277263992169454e-11,3026.874109167803,1156.1630300350205],[-1243.5667427870285,2769.4638366627923,1107.002042513259]],
					[[2249.633371341245,2038.5136450111863,1107.00204251326],[1620.0833176699705,2229.8533880979057,1956.2066987911328]],
					[[2633.9166285019373,1509.5931175154356,49.160987521760575],[1779.151961914786,2448.7925941502604,0]],
					[[621.7833713935172,2567.4341725069353,2164.843097504758],[1243.5667427870335,1711.6227816712894,2818.624824184552]],
					[[-1099.576383614374,-1513.4370545838972,3026.874109167793],[-1.824662845956363e-12,-1057.8410549915034,3472.4065508643457]],
					[[-5.473988537869089e-12,-2115.6821099829986,2818.624824184552],[-1099.576383614374,-1513.4370545838972,3026.874109167793]],
					[[-5.473988537869089e-12,-2115.6821099829986,2818.624824184552],[-1.824662845956363e-12,-1057.8410549915034,3472.4065508643457]],
					[[-3018.1998856626215,326.8908633399071,49.160987521760575],[-2878.728345529142,-935.3555395663441,0]],
					[[-5.473988537869089e-12,-2115.6821099829986,2818.624824184552],[-1006.0666285542153,-2442.5729733228973,2164.8430975047595]],
					[[-2878.728345529142,-935.3555395663441,0],[-2249.6333713412364,-2038.5136450111863,49.16098752175943]],
					[[-4.0142582611039987e-11,-3026.874109167806,0],[-1243.5667427870394,-2769.463836662794,49.160987521760575]],
					[[2633.9166285019264,-1509.5931175154503,1107.00204251326],[1779.1519619147455,-2448.7925941502913,1156.1630300350205]],
					[[0,-2756.2503675472317,1956.2066987911328],[-5.473988537869089e-12,-2115.6821099829986,2818.624824184552]],
					[[1006.0666285542037,-2442.5729733228973,2164.843097504758],[-5.473988537869089e-12,-2115.6821099829986,2818.624824184552]],
					[[1099.576383614374,-1513.4370545839008,3026.874109167793],[1006.0666285542147,-326.89086333990076,3472.4065508643444]],
					[[2012.133257108411,-653.7817266797988,2818.624824184552],[1099.576383614374,-1513.4370545839008,3026.874109167793]],
					[[1099.576383614374,-1513.4370545839008,3026.874109167793],[-1.824662845956363e-12,-1057.8410549915034,3472.4065508643457]],
					[[2012.133257108415,-1711.6227816713038,2164.8430975047595],[1099.576383614374,-1513.4370545839008,3026.874109167793]],
					[[-3018.1998856626215,326.8908633399071,49.160987521760575],[-2633.9166285019214,1509.5931175154428,49.16098752175943]],
					[[621.7833713935099,-2971.493500818646,1107.002042513259],[1243.5667427870262,-2769.463836662794,49.16098752175943]],
					[[-2249.6333713412364,-2038.5136450111863,49.16098752175943],[-1243.5667427870394,-2769.463836662794,49.160987521760575]],
					[[1243.5667427870262,-2769.463836662794,49.16098752175943],[-4.0142582611039987e-11,-3026.874109167806,0]],
					[[1099.576383614374,-1513.4370545839008,3026.874109167793],[-5.473988537869089e-12,-2115.6821099829986,2818.624824184552]],
					[[1099.576383614374,-1513.4370545839008,3026.874109167793],[1006.0666285542037,-2442.5729733228973,2164.843097504758]],
					[[621.7833713935172,2567.4341725069353,2164.843097504758],[0,1870.7110791327584,3026.874109167793]]
				].map(points=>points.map(([a,b,c])=>[b,c,a]).map(point=>new THREE.Vector3(...point.map(v=>v * SCALE))));

				uniqueEdges.forEach(ue => {
					let cylinder = createCylinder(ue[0], ue[1], scene);
					cylinders.push(cylinder);
				});

				let mergedCylinders = THREE.BufferGeometryUtils.mergeBufferGeometries( cylinders );
				// scene.add(new THREE.Mesh(mergedCylinders, tubeMaterial));

				nLights = lights.length;

				const _color = new THREE.Color();
				color = new Float32Array( nLights * 3 );

				colorInstancedBufferAttribute = new THREE.InstancedBufferAttribute( color, 3 );
				geometry.setAttribute( 'color', colorInstancedBufferAttribute );
				material.vertexColors = true;

				const lightInstances = new THREE.InstancedMesh( geometry, material, nLights );

				lights.forEach((light, idx)=>{
					light.updateMatrix();
					lightInstances.setMatrixAt(idx, light.matrix);
					light.material.dispose();
				});

				scene.add( lightInstances );

				// render();
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				videoCanvas.width = Math.floor(video.clientWidth);
				videoCanvas.height = Math.floor(video.clientHeight);

				render();
			}

			function animate(timestamp) {
				requestAnimationFrame( animate );
				let diff = timestamp - lastFrame;
				lastFrame = timestamp;
				controls.update();
				let offset = diff/5000;
				(vizualisations[selector.value])(offset, timestamp);
				// do stuff
				colorInstancedBufferAttribute.needsUpdate = true;
				render();
			}

			function render() {
				renderer.render( scene, camera );
			}
		</script>
	</body>
</html>